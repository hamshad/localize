---
phase: 05-ui-redesign
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - mapdata.go
  - maprender.go
autonomous: true
requirements: [UI-01, UI-02]

must_haves:
  truths:
    - "Map bitmap has significantly more detail than the current 240x96 (target ~480x192)"
    - "Map dynamically scales braille output to fit any terminal width and height"
    - "Scaling preserves land/water accuracy (no visual corruption at any size)"
  artifacts:
    - path: "mapdata.go"
      provides: "High-resolution world map bitmap data"
      contains: "bitmap"
    - path: "maprender.go"
      provides: "Braille rendering engine with dynamic scaling"
      exports: ["RenderBrailleMap", "ScaleBitmap"]
  key_links:
    - from: "maprender.go"
      to: "mapdata.go"
      via: "imports bitmap data"
      pattern: "bitmap"
    - from: "maprender.go"
      to: "tcell"
      via: "terminal size query for scaling"
      pattern: "Screen.*Size|terminalWidth|terminalHeight"
---

<objective>
Create a high-resolution world map bitmap and a dynamic braille rendering engine that scales to fill any terminal size.

Purpose: The map is the centerpiece of the ricing display. It must be large, detailed, and adapt to the user's terminal dimensions. Currently the 240x96 bitmap produces a fixed 120x24 braille grid — far too small for a fullscreen display.

Output: Two new files — `mapdata.go` (bitmap) and `maprender.go` (scaling + rendering engine). The existing `getBrailleWorldMap()` in main.go will be replaced in Plan 02.
</objective>

<execution_context>
@/Users/moksha/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/moksha/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-ui-redesign/05-CONTEXT.md
@main.go (lines 189-330 — current getBrailleWorldMap and bitmap)
@daynight.go (current colorizeBrailleMap functions — will need to consume new renderer)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create high-resolution world map bitmap</name>
  <files>mapdata.go</files>
  <action>
Create `mapdata.go` in package main containing a high-resolution equirectangular world map bitmap.

Target resolution: **480 columns x 192 rows** (4x the current 240x96). This produces a native braille grid of 240x48 — filling a typical 250-col ricing terminal nicely.

The bitmap should be a `var WorldBitmap []string` where each string is 480 characters of '0' (water) and '1' (land).

Build this by carefully scaling up the existing 240x96 bitmap with added detail:
- More defined coastlines (Mediterranean, Southeast Asia archipelago, Japan, UK/Ireland, Scandinavia, Caribbean islands, New Zealand)
- Visible major islands (Madagascar, Sri Lanka, Iceland, Cuba, Borneo, Sumatra, Philippines)
- More defined Great Lakes, Caspian Sea, Black Sea
- Better-defined peninsulas (Italy, Korea, India, Arabian, Florida, Baja California)
- Antarctica should still fill the bottom rows but with some coastal detail

Each row is exactly 480 characters. Total 192 rows. Use the existing bitmap as the structural reference — it's geographically correct, just low resolution.

Also include a `var WorldBitmapWidth = 480` and `var WorldBitmapHeight = 192` for convenience.
  </action>
  <verify>
    <automated>go build . 2>&1 | head -20</automated>
    <manual>Check that mapdata.go compiles and WorldBitmap has 192 rows of 480 chars each</manual>
  </verify>
  <done>mapdata.go exists with 192-row bitmap at 480-column width, builds cleanly</done>
</task>

<task type="auto">
  <name>Task 2: Create dynamic braille scaling and rendering engine</name>
  <files>maprender.go</files>
  <action>
Create `maprender.go` in package main with the braille rendering engine that dynamically scales the bitmap to any terminal size.

**Core functions:**

1. `ScaleBitmap(src []string, srcW, srcH, dstW, dstH int) [][]bool` — Scale the bitmap to target pixel dimensions using nearest-neighbor sampling. Input: string bitmap. Output: 2D bool grid (true=land).

2. `RenderBrailleMap(termWidth, termHeight int) string` — Main entry point. Given terminal dimensions:
   - Subtract 2 for border (top/bottom), 1 for status bar → available rows
   - Calculate target braille grid: `brailleCols = termWidth - 2` (border), `brailleRows = termHeight - 3`
   - Calculate pixel dimensions: `pixelW = brailleCols * 2`, `pixelH = brailleRows * 4`
   - Scale WorldBitmap to pixelW x pixelH
   - Encode scaled bitmap into braille characters (same encoding as current: dots 0x01-0x80 at base U+2800)
   - Return the multi-line braille string (no color tags — colorization is separate)

3. `GetBrailleGridSize(termWidth, termHeight int) (cols, rows int)` — Returns the braille grid dimensions for a given terminal size. Used by city marker positioning and day/night overlay.

4. `LatLonToBraille(lat, lon float64, brailleCols, brailleRows int) (col, row int)` — Convert geographic coordinates to braille grid position. Uses equirectangular projection:
   - `col = int((lon + 180.0) / 360.0 * float64(brailleCols))`
   - `row = int((90.0 - lat) / 180.0 * float64(brailleRows))`
   - Clamp to grid bounds.

**Braille encoding** (same as current main.go lines 298-330):
```
Dot positions:
(0,0)=0x01  (1,0)=0x08
(0,1)=0x02  (1,1)=0x10
(0,2)=0x04  (1,2)=0x20
(0,3)=0x40  (1,3)=0x80
Base: U+2800
```

**Important:** Do NOT import tview or tcell in this file. It's a pure rendering library. Terminal size will be passed in by the caller.
  </action>
  <verify>
    <automated>go build . 2>&1 | head -20</automated>
    <manual>Verify maprender.go exports RenderBrailleMap, ScaleBitmap, GetBrailleGridSize, LatLonToBraille</manual>
  </verify>
  <done>maprender.go builds cleanly, exports 4 functions. RenderBrailleMap(200, 50) produces a braille string with ~47 rows of ~198 characters. LatLonToBraille correctly maps NYC (40.7, -74.0) to roughly center-left of the grid.</done>
</task>

</tasks>

<verification>
- `go build .` passes with no errors (new files don't conflict with existing code since old getBrailleWorldMap is still in main.go)
- `go vet ./...` clean
- mapdata.go: `len(WorldBitmap) == 192`, `len(WorldBitmap[0]) == 480`
- maprender.go: All 4 functions exported and callable
</verification>

<success_criteria>
- High-resolution bitmap with visibly more detail than current (islands, coastlines, peninsulas)
- Scaling engine produces valid braille at any terminal size from 80x24 to 300x80
- New code coexists with old code (no breakage — old layout still works until Plan 02 replaces it)
</success_criteria>

<output>
After completion, create `.planning/phases/05-ui-redesign/05-01-SUMMARY.md`
</output>
