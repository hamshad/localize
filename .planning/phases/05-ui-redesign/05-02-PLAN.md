---
phase: 05-ui-redesign
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - main.go
  - daynight.go
  - cities.go
  - navigation.go
autonomous: true
requirements: [UI-03, UI-04, UI-05]

must_haves:
  truths:
    - "Map fills the entire terminal with no panels stealing rows"
    - "Each city shows its 3-letter abbreviation + current 12hr time on the map"
    - "Selected city marker pulses/blinks visually"
    - "A minimal 1-row status bar shows city date and time in 12hr format"
    - "A small menu indicator is visible in a corner"
  artifacts:
    - path: "main.go"
      provides: "Fullscreen map layout replacing old split-panel layout"
      contains: "tview.Pages"
    - path: "daynight.go"
      provides: "Day/night overlay adapted for dynamic grid size"
      contains: "colorizeBrailleMapWithDayNight"
    - path: "cities.go"
      provides: "City data with Coordinates used for map positioning"
      contains: "LatLonToBraille"
  key_links:
    - from: "main.go"
      to: "maprender.go"
      via: "calls RenderBrailleMap with terminal dimensions"
      pattern: "RenderBrailleMap"
    - from: "main.go"
      to: "cities.go"
      via: "uses LatLonToBraille for city marker positioning"
      pattern: "LatLonToBraille"
    - from: "daynight.go"
      to: "maprender.go"
      via: "uses GetBrailleGridSize for longitude calculations"
      pattern: "GetBrailleGridSize"
---

<objective>
Tear down the old split-panel layout and replace it with a fullscreen map display. Add dynamic city markers with live times, a pulsing selected-city effect, and a minimal status bar.

Purpose: This is the core layout transformation — from dashboard to ricing showpiece. The map becomes the entire UI, with city times rendered directly on it.

Output: Completely rewritten main.go layout, updated daynight.go for dynamic grid, updated city marker system.
</objective>

<execution_context>
@/Users/moksha/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/moksha/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-ui-redesign/05-CONTEXT.md
@.planning/phases/05-ui-redesign/05-01-SUMMARY.md
@main.go
@daynight.go
@cities.go
@navigation.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace layout with fullscreen map + tview.Pages for overlays</name>
  <files>main.go, daynight.go</files>
  <action>
**Gut the old layout in main.go.** Remove:
- `header` TextView (3 rows)
- `leftClockView` / `rightClockView` TextViews and `clockRow` Flex
- `navView` TextView (10 rows)
- `modeView` TextView (8 rows)
- `footer` TextView (1 row)
- The old `mainLayout` Flex with all its AddItem calls
- `getBrailleWorldMap()` function and the hardcoded bitmap (now in mapdata.go)
- `colorizeBrailleMap()` function (replaced by new system)
- `formatClockPanel()` function (clocks move to overlay)
- The `cityMarkers` var (replaced by dynamic positioning)

**Create new layout:**

```go
// Root: tview.Pages (allows overlays on top of map)
pages := tview.NewPages()

// Base layer: fullscreen map
mapView := tview.NewTextView().
    SetDynamicColors(true).
    SetTextAlign(tview.AlignCenter).
    SetScrollable(false)
mapView.SetBorder(false) // No border — map IS the screen

// Status bar: 1 row at bottom
statusBar := tview.NewTextView().
    SetDynamicColors(true).
    SetTextAlign(tview.AlignLeft).
    SetScrollable(false)
statusBar.SetBorder(false)

// Layout: map fills everything except 1 row for status
baseLayout := tview.NewFlex().SetDirection(tview.FlexRow).
    AddItem(mapView, 0, 1, false).  // fills all available space
    AddItem(statusBar, 1, 0, false) // 1 fixed row at bottom

pages.AddPage("base", baseLayout, true, true)
app.SetRoot(pages, true)
```

**Update `updateUI()` to:**
1. Get terminal size via `app.GetScreen().Size()` (returns width, height in chars)
2. Call `RenderBrailleMap(width, height-1)` (subtract 1 for status bar)
3. Overlay city markers with time labels (see Task 2)
4. Apply day/night colorization if enabled
5. Set mapView text
6. Update status bar: show selected city's date/time in 12hr format, or current local time if no selection. Format: `City Name  Mon Jan 2  3:04 PM`. Right-align a small `[=]` menu indicator.

**Update daynight.go:**
- `colorizeBrailleMapWithDayNight()` must accept the braille grid dimensions as parameters instead of assuming fixed 120-column width
- Longitude calculation: `longitude = -180.0 + float64(brailleCol) / float64(totalBrailleCols) * 360.0`
- Remove hardcoded `cityMarkers` references — city overlay happens separately now
- Keep the same 6-phase color scheme (dawn, morning, day, dusk, evening, night)

**Keep the 1-second ticker goroutine** — it still calls `app.QueueUpdateDraw(func() { updateUI() })`.
  </action>
  <verify>
    <automated>go build . 2>&1 | head -20</automated>
    <manual>Run `./localize` — map should fill the entire terminal. Status bar at bottom. No panels visible.</manual>
  </verify>
  <done>App launches with fullscreen map. No header, no clock panels, no mode panel, no footer. Status bar shows time in 12hr format. Day/night overlay still works with D key.</done>
</task>

<task type="auto">
  <name>Task 2: Dynamic city markers with live time + pulsing selection</name>
  <files>main.go, cities.go, navigation.go</files>
  <action>
**City markers on the map** — Replace the old hardcoded `cityMarkers` with dynamic positioning:

In the `updateUI()` map rendering pipeline, after generating the braille string but before setting mapView text:

1. For each configured city (from `leftRegions` + `rightRegions`):
   - Get its coordinates from `AllCities` (the `Coordinates [2]float64` field — [lat, lon])
   - Call `LatLonToBraille(lat, lon, brailleCols, brailleRows)` to get grid position
   - Generate label: `"NYC 2:30p"` format — 3-letter abbreviation + time in compact 12hr (no seconds, lowercase am/pm abbreviated to just a/p)
   - Replace braille characters at that position with the colored label text

2. **3-letter abbreviation mapping:** Add a `func (c City) Abbreviation() string` method to City in cities.go that returns a 3-letter code. Use existing IATA-like codes where they exist, derive for others:
   - New York → NYC, London → LON, Tokyo → TYO, Paris → PAR, Sydney → SYD, etc.
   - For cities without obvious codes: first 3 letters of city name (e.g., Mumbai → MUM, Singapore → SIN, Bangkok → BKK)

3. **Compact time format:** `3:04p` — hour (no leading zero), colon, minute, then 'a' or 'p'. So "NYC 2:30p" is 10 chars. Use `time.Format("3:04p")` — Go's lowercase pm would need custom: format as `time.Format("3:04PM")` then replace "PM"→"p", "AM"→"a".

4. **Overlap avoidance:** If two city labels would overlap (their grid positions are within label-width of each other), offset the second one down by 1 row. Simple: track occupied columns per row, nudge down if collision.

5. **Pulsing selected city:** In navigation.go, track a `pulseState bool` that toggles every 500ms (use the existing 1-second ticker, or add a simple tick counter). When a city is selected:
   - On pulse=true: render its label in **bright white on a colored background** (e.g., `[white:red:b]NYC 2:30p[-:-:-]`)
   - On pulse=false: render normally but with a `*` prefix: `[yellow::]* NYC 2:30p[-]`
   - This creates a visible blink effect every second

6. **Navigation changes:** The old navigation system used up/down to move through clock panel entries. Now navigation moves between city markers on the map. Keep the same Up/Down/Tab/Enter keys but:
   - Up/Down cycles through cities (sorted by longitude for geographic sense)
   - Tab isn't needed anymore (no left/right panels) — could cycle categories instead
   - Enter could open the city detail overlay (handled in Plan 03)
   - Escape deselects

**Status bar update:** When a city is selected, the status bar shows:
`[cityColor]NYC[white]  New York  Mon Jan 2  3:04 PM EST  [darkgray][=][-]`

When no city selected:
`[green]Local[white]  Mon Jan 2  3:04 PM  [darkgray][=][-]`

Right-pad the `[=]` to the right edge using spaces calculated from terminal width.
  </action>
  <verify>
    <automated>go build . 2>&1 | head -20</automated>
    <manual>Run `./localize` — cities should appear as "NYC 2:30p" labels on the map at correct geographic positions. Arrow keys cycle between them with a pulse effect. Status bar updates.</manual>
  </verify>
  <done>Cities render as abbreviated labels with live times at correct map positions. Selected city pulses. Status bar shows selected city info in 12hr format. Menu indicator [=] visible at bottom-right.</done>
</task>

</tasks>

<verification>
- `go build .` and `go vet ./...` clean
- App launches fullscreen — map fills terminal
- Cities visible on map with 3-letter codes and times
- Up/Down arrow cycles city selection with visible pulse
- Day/night overlay works (D key) with dynamic grid
- Status bar shows time in 12hr format
- `[=]` indicator visible at bottom-right
</verification>

<success_criteria>
- Zero panels visible — only map + 1-row status bar
- City markers geographically accurate (NYC in northeast US, TYO in Japan, SYD in southeast Australia)
- 12hr time format everywhere (no 24hr, no seconds)
- Pulsing selection clearly visible
- Works on terminals from 80x24 to 300x80
</success_criteria>

<output>
After completion, create `.planning/phases/05-ui-redesign/05-02-SUMMARY.md`
</output>
