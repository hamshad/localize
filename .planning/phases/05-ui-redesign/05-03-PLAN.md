---
phase: 05-ui-redesign
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - main.go
  - overlay.go
  - asciiclock.go
  - converter.go
  - timer.go
  - stopwatch.go
  - alarm.go
  - meeting.go
  - mode.go
autonomous: false
requirements: [UI-06, UI-07, UI-08]

must_haves:
  truths:
    - "M, Space, or Enter opens a centered menu overlay listing all features"
    - "Selecting a feature from the menu opens that feature in a centered modal box"
    - "Escape closes the modal back to menu, then back to map"
    - "Features work correctly inside modal boxes (timer counts, converter converts, etc.)"
    - "An ASCII analog clock is rendered inside relevant overlays"
    - "Clock list is available as a menu option showing all city times"
  artifacts:
    - path: "overlay.go"
      provides: "Menu overlay system and modal box rendering"
      exports: ["OverlayManager", "ShowMenu", "ShowFeature", "CloseOverlay"]
    - path: "asciiclock.go"
      provides: "ASCII analog clock renderer"
      exports: ["RenderASCIIClock"]
    - path: "main.go"
      provides: "Key bindings wired to overlay system"
      contains: "overlayManager"
  key_links:
    - from: "main.go"
      to: "overlay.go"
      via: "M/Space/Enter opens menu, Escape closes"
      pattern: "overlayManager.ShowMenu|overlayManager.CloseOverlay"
    - from: "overlay.go"
      to: "mode.go"
      via: "delegates to mode handlers for feature content"
      pattern: "handler.Render"
    - from: "overlay.go"
      to: "asciiclock.go"
      via: "embeds ASCII clock in feature overlays"
      pattern: "RenderASCIIClock"
    - from: "overlay.go"
      to: "tview.Pages"
      via: "adds/removes overlay pages dynamically"
      pattern: "pages.AddPage|pages.RemovePage"
---

<objective>
Build the menu overlay system, feature modal boxes, ASCII analog clock, and rewire all existing features to work inside centered overlay modals.

Purpose: This completes the ricing UI — features are accessible but hidden behind an elegant overlay system. The ASCII clock adds visual richness that makes the app look stunning in screenshots.

Output: New overlay.go (menu + modal system), new asciiclock.go (analog clock renderer), updated mode handlers and main.go key bindings.
</objective>

<execution_context>
@/Users/moksha/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/moksha/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-ui-redesign/05-CONTEXT.md
@.planning/phases/05-ui-redesign/05-01-SUMMARY.md
@.planning/phases/05-ui-redesign/05-02-SUMMARY.md
@main.go
@mode.go
@converter.go
@timer.go
@stopwatch.go
@alarm.go
@meeting.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ASCII analog clock renderer</name>
  <files>asciiclock.go</files>
  <action>
Create `asciiclock.go` in package main with a function `RenderASCIIClock(t time.Time) string` that returns a multi-line ASCII art analog clock face.

**Clock design** (~13 lines tall, ~25 chars wide):

```
        12
    11  |   1
      \ | /
  10 ---+--- 2
      / | \
    9   |   3
        6
```

But rendered as a proper circle using Unicode box-drawing or simple ASCII:

```
       .---.
     /  12  \
   /11   |  1\
  |10  --+-- 2|
  | 9   /|  3 |
   \ 8 / | 4 /
     \  6  /
       '---'
```

**Requirements:**
- Show hour hand and minute hand as directional characters:
  - Hour hand: short line (1-2 chars from center) pointing to current hour
  - Minute hand: longer line (2-3 chars from center) pointing to current minute
  - Use characters: `|` `/` `\` `-` for directions, or Unicode arrows
- Use 12-hour format (the clock face naturally is 12hr)
- Numbers 1-12 placed around the circumference
- Use tview color tags: clock face in `[white]`, hour hand in `[yellow::b]`, minute hand in `[green]`
- Function takes `time.Time` and returns the complete colored string

**Size target:** Approximately 13 rows x 27 columns — fits nicely inside a modal box.

Keep this file pure (no tview/tcell imports needed — just string building with tview color tags).
  </action>
  <verify>
    <automated>go build . 2>&1 | head -20</automated>
    <manual>The function should compile. Visual verification in Plan 03 Task 2.</manual>
  </verify>
  <done>asciiclock.go builds cleanly, RenderASCIIClock returns a multi-line colored ASCII clock face with hour/minute hands positioned correctly for the given time.</done>
</task>

<task type="auto">
  <name>Task 2: Build menu overlay system and rewire features into modals</name>
  <files>overlay.go, main.go, converter.go, timer.go, stopwatch.go, alarm.go, meeting.go, mode.go</files>
  <action>
**Create overlay.go** with the overlay/modal system:

```go
type OverlayState int
const (
    OverlayNone OverlayState = iota
    OverlayMenu
    OverlayFeature
)

type OverlayManager struct {
    state         OverlayState
    pages         *tview.Pages
    selectedIndex int           // menu cursor position
    menuItems     []MenuItem
    activeFeature Mode          // which feature is open
    app           *tview.Application
}

type MenuItem struct {
    Label string
    Mode  Mode
    Icon  string  // e.g., ">" or unicode symbol
}
```

**Menu overlay:**
- `ShowMenu()` — Creates a centered `tview.TextView` (or Flex with border) sized ~30 cols x 12 rows, overlaid on the map via `pages.AddPage("menu", ..., false, true)`
- Menu items: Clocks, Converter, Stopwatch, Timer, Alarm, Meeting Planner
- Current selection highlighted with `[black:white]` (inverted colors)
- Up/Down to navigate menu, Enter to select, Escape to close
- Use `tview.Flex` with centering trick:
  ```go
  modal := tview.NewFlex().SetDirection(tview.FlexRow).
      AddItem(nil, 0, 1, false).  // top spacer
      AddItem(tview.NewFlex().
          AddItem(nil, 0, 1, false).  // left spacer
          AddItem(menuContent, 30, 0, true).  // menu box
          AddItem(nil, 0, 1, false), // right spacer
      0, 1, true).
      AddItem(nil, 0, 1, false)  // bottom spacer
  ```

**Feature modal overlay:**
- `ShowFeature(mode Mode)` — Opens a centered modal (~60 cols x 20 rows, adjustable per feature) showing the feature's `Render()` output
- For features with the ASCII clock (Timer, Stopwatch, Alarm), embed `RenderASCIIClock(time.Now())` in the modal alongside the feature content, laid out side-by-side or stacked
- For Clocks feature: render all configured city times in 12hr format, grouped by category — essentially the old clock panels but in a modal box
- The modal gets its own border + title (e.g., `[ Timer ]`, `[ Converter ]`)
- Feature content refreshes every tick via updateUI()

**Rewire main.go key bindings:**

The `SetInputCapture` needs to handle overlay state:

```
if overlayManager.state == OverlayMenu:
    Up/Down → navigate menu
    Enter → open selected feature
    Escape/M/Space → close menu
    
elif overlayManager.state == OverlayFeature:
    Escape → close feature, return to menu (or directly to map)
    All other keys → delegate to feature's HandleKey/HandleSpecialKeyEvent
    
else (OverlayNone — normal map view):
    M/Space/Enter → open menu
    Up/Down → cycle city selection on map
    D → toggle day/night
    Escape/Q → quit (only when no overlay open)
```

**Remove old mode switching keys** (C, S, T, A, M for modes) — these are now accessed through the menu. The `M` key now opens the menu instead of meeting mode.

**Update mode handlers** (converter, timer, stopwatch, alarm, meeting):
- Their `Render()` methods should work as-is (they return strings)
- The overlay system calls `Render()` and embeds the result in the modal box
- Key handling is delegated by the overlay manager, not by the old mode switching system
- No changes needed to the core logic of any handler — only the presentation wrapper changes

**Clocks feature** — a new simple renderer (can be a function in overlay.go):
- `RenderClockList(regions []Region) string` — formats all city times:
  ```
  Americas & Europe
    NYC  New York      3:04 PM  Mon Jan 2
    LON  London        8:04 PM  Mon Jan 2
    ...
  
  Asia & Oceania
    TYO  Tokyo         5:04 AM  Tue Jan 3
    SYD  Sydney        7:04 AM  Tue Jan 3
  ```
  </action>
  <verify>
    <automated>go build . 2>&1 | head -20</automated>
    <manual>Run ./localize. Press M/Space/Enter to open menu. Navigate with arrows, Enter to select Timer. Timer should work inside modal. Escape back to menu, Escape back to map. Verify ASCII clock is rendered in Timer/Stopwatch modals.</manual>
  </verify>
  <done>Menu opens via M/Space/Enter as centered overlay. Features accessible through menu. Timer, Converter, Stopwatch, Alarm, Meeting all work inside modal boxes. ASCII clock visible in relevant modals. Escape navigation: feature → menu → map. Clock list available as menu option.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Visual verification of complete UI redesign</name>
  <action>
Complete UI redesign: fullscreen map with dynamic scaling, city markers showing live times, pulsing selection, menu overlay system with centered modal boxes, ASCII analog clock, all features working inside overlays.
  </action>
  <how-to-verify>
1. Launch: `./localize` — verify map fills entire terminal, no panels visible
2. Resize terminal — map should scale dynamically
3. Check city markers show 3-letter codes with times (e.g., "NYC 2:30p")
4. Press Up/Down — cycle city selection, verify pulsing effect
5. Press D — day/night overlay on fullscreen map
6. Press M (or Space, or Enter) — menu overlay should appear centered
7. Navigate menu with arrows, select "Timer" — timer modal with ASCII clock
8. Start a timer (T, type digits, Space) — verify it counts down inside modal
9. Press Escape — back to menu
10. Select "Converter" — verify it works
11. Select "Clocks" — all city times in 12hr format
12. Press Escape twice — back to fullscreen map
13. Verify `[=]` indicator visible at bottom-right corner
14. Verify status bar shows city time in 12hr format
15. Press Q or Escape (from map) — app should quit
  </how-to-verify>
  <verify>Manual visual and interactive verification per steps above</verify>
  <done>User approves the complete UI redesign works as specified</done>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
- `go build .` and `go vet ./...` clean
- Full interaction flow: map → menu → feature → menu → map
- All 6 features work inside modals
- ASCII clock renders with correct hand positions
- No freeze or deadlock (QueueUpdateDraw rules still respected)
- Day/night overlay works on fullscreen map
</verification>

<success_criteria>
- App looks like a ricing showpiece — fullscreen map dominates
- Features are cleanly tucked behind menu overlay
- ASCII clock adds visual richness
- All existing functionality preserved (just presented differently)
- Clean escape path: feature → menu → map → quit
</success_criteria>

<output>
After completion, create `.planning/phases/05-ui-redesign/05-03-SUMMARY.md`
</output>
