package main

import (
	"flag"
	"fmt"
	"os"
	"strings"
	"time"

	"github.com/gdamore/tcell/v2"
	"github.com/rivo/tview"
)

// CLI flag variables
var (
	flagCities string
	flagPreset string
	flagList   bool
)

// Preset city groups
var presets = map[string][]string{
	"business": {"New York", "London", "Tokyo", "Singapore"},
	"family":   {"Los Angeles", "London", "Paris", "Sydney"},
	"americas": {"Honolulu", "Anchorage", "Los Angeles", "New York", "Sao Paulo"},
	"europe":   {"London", "Paris", "Moscow"},
	"asia":     {"Dubai", "Mumbai", "Singapore", "Shanghai", "Tokyo"},
}

// GetConfiguredCities returns the list of cities to display based on CLI flags and presets.
func GetConfiguredCities() ([]Region, []Region, bool) {
	// Check -list flag first
	if flagList {
		fmt.Println("Available cities:")
		fmt.Println("\nAmericas & Europe:")
		for _, r := range leftRegions {
			fmt.Printf("  - %s (%s)\n", r.Name, r.Timezone)
		}
		fmt.Println("\nAsia, Africa & Oceania:")
		for _, r := range rightRegions {
			fmt.Printf("  - %s (%s)\n", r.Name, r.Timezone)
		}
		fmt.Println("\nAvailable presets:")
		for name := range presets {
			fmt.Printf("  - %s\n", name)
		}
		return nil, nil, false
	}

	// Check preset flag
	if flagPreset != "" {
		if cities, ok := presets[flagPreset]; ok {
			return filterRegionsByNames(cities)
		} else {
			fmt.Fprintf(os.Stderr, "Unknown preset: %s\n", flagPreset)
			os.Exit(1)
		}
	}

	// Check -cities flag
	if flagCities != "" {
		cityNames := strings.Split(flagCities, ",")
		// Trim whitespace from each city name
		for i, name := range cityNames {
			cityNames[i] = strings.TrimSpace(name)
		}
		return filterRegionsByNames(cityNames)
	}

	// Default: show all regions
	return leftRegions, rightRegions, true
}

// filterRegionsByNames filters the left and right region lists to only include the specified cities.
func filterRegionsByNames(cityNames []string) ([]Region, []Region, bool) {
	var left, right []Region
	for _, name := range cityNames {
		found := false
		for _, r := range leftRegions {
			if strings.EqualFold(r.Name, name) {
				left = append(left, r)
				found = true
				break
			}
		}
		if !found {
			for _, r := range rightRegions {
				if strings.EqualFold(r.Name, name) {
					right = append(right, r)
					break
				}
			}
		}
	}
	return left, right, len(left)+len(right) > 0
}

// Region represents a major world region with timezone info.
type Region struct {
	Name     string
	Timezone string
	Color    tcell.Color
}

var leftRegions = []Region{
	{Name: "Honolulu", Timezone: "Pacific/Honolulu", Color: tcell.ColorTurquoise},
	{Name: "Anchorage", Timezone: "America/Anchorage", Color: tcell.ColorLightCyan},
	{Name: "Los Angeles", Timezone: "America/Los_Angeles", Color: tcell.ColorDarkCyan},
	{Name: "New York", Timezone: "America/New_York", Color: tcell.ColorDodgerBlue},
	{Name: "Sao Paulo", Timezone: "America/Sao_Paulo", Color: tcell.ColorLimeGreen},
	{Name: "London", Timezone: "Europe/London", Color: tcell.ColorGreen},
	{Name: "Paris", Timezone: "Europe/Paris", Color: tcell.ColorDarkGreen},
	{Name: "Moscow", Timezone: "Europe/Moscow", Color: tcell.ColorRed},
}

var rightRegions = []Region{
	{Name: "Cairo", Timezone: "Africa/Cairo", Color: tcell.ColorSandyBrown},
	{Name: "Nairobi", Timezone: "Africa/Nairobi", Color: tcell.ColorCoral},
	{Name: "Dubai", Timezone: "Asia/Dubai", Color: tcell.ColorGold},
	{Name: "Mumbai", Timezone: "Asia/Kolkata", Color: tcell.ColorOrange},
	{Name: "Singapore", Timezone: "Asia/Singapore", Color: tcell.ColorDarkMagenta},
	{Name: "Shanghai", Timezone: "Asia/Shanghai", Color: tcell.ColorOrangeRed},
	{Name: "Tokyo", Timezone: "Asia/Tokyo", Color: tcell.ColorDeepPink},
	{Name: "Sydney", Timezone: "Australia/Sydney", Color: tcell.ColorYellow},
}

// cityMarker defines a city's position on the braille map and its display label.
type cityMarker struct {
	label string
	row   int // row in the braille output (0-indexed)
	col   int // col in the braille output (0-indexed, in characters)
	color string
}

var cityMarkers = []cityMarker{
	{label: "HNL", row: 9, col: 4, color: "turquoise"},
	{label: "ANC", row: 3, col: 10, color: "lightcyan"},
	{label: "LA", row: 7, col: 20, color: "darkcyan"},
	{label: "NYC", row: 6, col: 33, color: "dodgerblue"},
	{label: "GRU", row: 15, col: 44, color: "limegreen"},
	{label: "LON", row: 5, col: 58, color: "green"},
	{label: "PAR", row: 4, col: 62, color: "darkgreen"},
	{label: "MOS", row: 4, col: 72, color: "red"},
	{label: "CAI", row: 8, col: 69, color: "sandybrown"},
	{label: "NBO", row: 12, col: 72, color: "coral"},
	{label: "DXB", row: 8, col: 78, color: "gold"},
	{label: "BOM", row: 9, col: 84, color: "orange"},
	{label: "SIN", row: 11, col: 94, color: "darkmagenta"},
	{label: "PVG", row: 7, col: 100, color: "orangered"},
	{label: "TYO", row: 7, col: 106, color: "deeppink"},
	{label: "SYD", row: 16, col: 110, color: "yellow"},
}

// getBrailleWorldMap returns the world map rendered in Braille Unicode characters.
// Each braille character encodes a 2-wide x 4-tall pixel grid.
// The bitmap below is 240 cols x 96 rows (=> 120 braille chars wide x 24 braille chars tall).
func getBrailleWorldMap() string {
	// The bitmap: 1 = land, 0 = water
	// 240 columns x 96 rows — a detailed equirectangular world map
	// Rows go top-to-bottom (north pole -> south pole)
	bitmap := []string{
		"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000", // 0
		"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000", // 1
		"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000", // 2
		"000000000000000000000000000000000000000000000000000000000000000000000000000000000111111111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000", // 3
		"000000000000000000000000000000000000000000000000000000000000000000000000000000001111111111111111111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000", // 4
		"000000000000000000000000000000000000000000000000000000000000000000000000000000111111111111111111111111111111100000000000000000111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000", // 5
		"000000000000000000000000000000000000000000000000000001111111111111111111110000111111111111111111111111111111100000000000000000111111111111000000000000000111111000000000000000000000000000000000000000000000000000000000000000000000000000000000", // 6
		"000000000000000000000000000000000000000000000000001111111111111111111111111000111111111111111111111111111111100000000000000000000111111000000000000000000111111000000000000000000000000000000000000000000000000000000000000000000000000000000000", // 7
		"000000000000000000000000000000000000000000000011111111111111111111111111111110001111111111111111111111111110000000000000000000000000000000000000000000000011111000000000000000000000000000000000000000000000000000000000000000000000000000000000", // 8
		"000000111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111100000000000000000000000011111111111111111111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000", // 9
		"000000111111111111111111101111111111111111111111111111111111111111111111111111111111111111111111111110000000000000000000000000001111111111111111111111111111111111111110000000000000000000000000000000000000000000000000000000000000000000000000", // 10
		"000000000111111111111100001111111111111111111111111111111111111111111111111111111001111111111110000000000000000000000000000000001111111111111111111111111111111111111111111111000000000000000000000000000000000000000000000000000000000000000000", // 11
		"000000000011111111111000001111111111111111111111111111111111111111111111111111000001111111111000000000001111111000000000000000111111111111111111111111111111111111111111111111111111100000000000000000000000000000000000000000000000000000000000", // 12
		"000000001111111111100000000001111111111111111111111111111111111111111111111000000000011111110000000000011111111100000000000000111111111111111111111111111111111111111111111111111111111111100000000000000000000000000000000000000000000000000000", // 13
		"000000111111111110000000000000001111111111111111111111111111111111111111100000000000001111100000000000001111111000000000000111111111100000111111111111111111111111111111111111111111111111111111110000000000000000000000000000000000000000000000", // 14
		"000000111111111100000000000000001111111111111111111111111111111111111111000000000000000111100000000000000000000000000000000111111111000000011111111111111111111111111111111111111111111111111111111110000000000000000000000000000000000000000000", // 15
		"000000111111111100000000000000000111111111111111111111111111111111111110000000000000000011100000000000000000000000111111000111111110000000001111111111111111111111111111111111111111111111111111111111111000000000000000000000000000000000000000", // 16
		"000000001111111110000000000011111111111111111111111111111111111111111111111111111110000000000000000000000000000000111111000001111110000000111111111111111111111111111111111111111111111111111111111111111111111000000000000000000000000000000000", // 17
		"000000001111111000000000000001111111111111111111111111111111111111111111111111111110000000000000000000000000000000011111111111111100000001111111111111111111111111111111111111111111111111111111111111111111111111111100000000000000000000000000", // 18
		"000000000000000000000000000000011111111111111111111111111111111111111111111111111110000000000000000000000000000001111111111111111111100011111111111111111111111111111111111111111111111111111111111111111111111111111111100000000000000000000000", // 19
		"000000000000000000000000000000000111111111111111111111111111111111111111111111111111000000000000000000000000000001111111111111111111111011111111111111111111111111111111111111111111111111111111111111111111111111111100000000000000000000000000", // 20
		"000000000000000000000000000000000011111111111111111111111111111111111111111111111110000000000000000000000000000000001111111111111111111110111111111111111111111111111111111111111111111111111111111111111111111110000000000000000000000000000000", // 21
		"000000000000000000000000000000000000111111111111111111111111111111111111111111111100000000000000000000000000000000000111111111111111111110001111111111111111111111111111111111111111111111111111111111111111111000000000000000000000000000000000", // 22
		"000000000000000000000000000000000000111111111111111111111111111111111111111111111000000000000000000000000000000000000011111111111111111111101111111111111111111111111111111111111111111111111111111111111111110000000111110000000000000000000000", // 23
		"000000000000000000000000000000000000011111111111111111111111111111111111111110000000000000000000000000000000000001111111111111111111111111101111111111111111111111111110000001111111111111111111111111111111111000000111110000000000000000000000", // 24
		"000000000000000000000000000000000000011111111111111111111111111111111111111000000000000000000000000000000000000001111111111111111111111111111111111111111111111110000000001111111111111111111111111111111111111000001111100000000000000000000000", // 25
		"000000000000000000000000000000000000001111111111111111111111111111111111100000000000000000000000000000000000000001111111111110001111111111111111111111111111111111000000011111111111111111111111111111111111111000001110000000000000000000000000", // 26
		"000000000000000000000000000000000000001111111111111111111111111111111110000000000000000000000000000000000000000001111111110000000111111111111111111111111111111111000000111111111111111111111111111111111110111000111110000000000000000000000000", // 27
		"000000000000000000000000000000000000000111111111111111111111111111111100000000000000000000000000000000000000000000111111111111111110001111000011110001111111111111111111111111111111111111111111111111111111110001111100000000000000000000000000", // 28
		"000000000000000000000000000000000000000011111111111111111111111111111000000000000000000000000000000000000000000000000011111111100000000000000000000000111111111111111111111110000000000000111111111111111100110011111000000000000000000000000000", // 29
		"000000000000000000000000000000000000000001111111111111111111111111110000000000000000000000000000000000000000000000000111111111111000000000000011111111111111111110111111111111000000000000001111111111111100001111000000000000000000000000000000", // 30
		"000000000000000000000000000000000000000000111111111111111111111111100000000000000000000000000000000000000000000000111111111111111111111000000011111111111111111110011111111111100000000000011111111111111100001110000000000000000000000000000000", // 31
		"000000000000000000000000000000000000000000111111111111111111111111100000000000000000000000000000000000000000000011111111111111111111111111111111111111111111111110001111111111111000000000111111111111111100001110000000000000000000000000000000", // 32
		"000000000000000000000000000000000000000000011111111111111111111111100000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111110001111111111111111111111111111111111111100000000000000000000000000000000000000", // 33
		"000000000000000000000000000000000000000000001111111111111111111111100000000000000000000000000000000000000000011111111111111111111111111111111110111111111111111111000111111111111111111111111111111111111000000000000000000000000000000000000000", // 34
		"000000000000000000000000000000000000000000000111111111111000000011111110000000000000000000000000000000000000011111111111111111111111111111111110011111111111111111000111111111111111111111111111111111100000000000000000000000000000000000000000", // 35
		"000000000000000000000000000000000000000000000011111111111000000011111110000000000000000000000000000000000000111111111111111111111111111111111111111111111111111000000011111111111111111111111111111110000000000000000000000000000000000000000000", // 36
		"000000000000000000000000000000000000000000000000011111111000000001111111111000000000000000000000000000000000111111111111111111111111111111111111111111111111111000000000111111111110011111111111110000111110000000000000000000000000000000000000", // 37
		"000000000000000000000000000000000000000000000000001111111110000000000001111000000000000000000000000000000000111111111111111111111111111111111111111011111111110000000000011111111100011111111111100000111111100000000000000000000000000000000000", // 38
		"000000000000000000000000000000000000000000000000000000111111110000000000000000000000000000000000000000000000111111111111111111111111111111111111111111111110000000000000001111100000000011111111100000111111100000000000000000000000000000000000", // 39
		"000000000000000000000000000000000000000000000000000000000011111000000000000000000000000000000000000000000000111111111111111111111111111111111111111111111100000000000000001111000000000001111111100000001111100000000000000000000000000000000000", // 40
		"000000000000000000000000000000000000000000000000000000000000011110001111111000000000000000000000000000000000011111111111111111111111111111111111111111111100000000000000001111000000000000111110000000000111100000000000000000000000000000000000", // 41
		"000000000000000000000000000000000000000000000000000000000000000011101111111111100000000000000000000000000000011111111111111111111111111111111111111111111100000000000000001111000000000000111110000000000011100000000000000000000000000000000000", // 42
		"000000000000000000000000000000000000000000000000000000000000000011111111111111111100000000000000000000000000001111111111111111111111111111111111111111111000000000000000001111100000000001111110000000000000000000000000000000000000000000000000", // 43
		"000000000000000000000000000000000000000000000000000000000000000000001111111111111111000000000000000000000000000011111111111111111111111111111111111111000000000000000000000011100000000011111100111111100000000000000000000000000000000000000000", // 44
		"000000000000000000000000000000000000000000000000000000000000000000001111111111111111110000000000000000000000000001111111111111111111111111111111111110000000000000000000000000000000000011111110111111111000000000000000000000000000000000000000", // 45
		"000000000000000000000000000000000000000000000000000000000000000000001111111111111111111000000000000000000000000000111111111111111111111111111111111110000000000000000000000000000000000011111111111111100000000000000000000000000000000000000000", // 46
		"000000000000000000000000000000000000000000000000000000000000000000001111111111111111111100000000000000000000000000000001111111111111111111111111111110000000000000000000000000000000000011111111111111100000000000000000000000000000000000000000", // 47
		"000000000000000000000000000000000000000000000000000000000000000000001111111111111111111110000000000000000000000000000000000001111111111111111111111110000000000000000000000000000000000011111111111111100000000000000000000000000000000000000000", // 48
		"000000000000000000000000000000000000000000000000000000000000000000001111111111111111111111111000000000000000000000000000000000111111111111111111111110000000000000000000000000000000000001111111111111000000001111111111111110000000000000000000", // 49
		"000000000000000000000000000000000000000000000000000000000000000000000111111111111111111111111110000000000000000000000000000000001111111111111111111110000000000000000000000000000000000000111111111111100000001111111111111111000000000000000000", // 50
		"000000000000000000000000000000000000000000000000000000000000000000000111111111111111111111111111100000000000000000000000000000000111111111111111111000000000000000000000000000000000000000000111111111111000000011111111111111100000000000000000", // 51
		"000000000000000000000000000000000000000000000000000000000000000000000111111111111111111111111111110000000000000000000000000000000011111111111111111000000000000000000000000000000000000000000000111111111111110001111111111111111000000000000000", // 52
		"000000000000000000000000000000000000000000000000000000000000000000000111111111111111111111111111100000000000000000000000000000000000111111111111111000000000000000000000000000000000000000000000000001111111111111111111111111000000000000000000", // 53
		"000000000000000000000000000000000000000000000000000000000000000000000111111111111111111111111110000000000000000000000000000000000000011111111111111111111100000000000000000000000000000000000000000000000000011111111111111111000000000000000000", // 54
		"000000000000000000000000000000000000000000000000000000000000000000000011111111111111111111111110000000000000000000000000000000000000001111111111111111111100000000000000000000000000000000000000000000000000111111111111111111100000000000000000", // 55
		"000000000000000000000000000000000000000000000000000000000000000000000000111111111111111111111100000000000000000000000000000000000000001111111111111001111100000000000000000000000000000000000000000000000011111111111111111000000000000000000000", // 56
		"000000000000000000000000000000000000000000000000000000000000000000000000011111111111111111111100000000000000000000000000000000000000000011111111110001111000000000000000000000000000000000000000000000000111111111111111111000000000000000000000", // 57
		"000000000000000000000000000000000000000000000000000000000000000000000000001111111111111111111000000000000000000000000000000000000000000001111111100001111000000000000000000000000000000000000000000000111111111111111111111110000000000000000000", // 58
		"000000000000000000000000000000000000000000000000000000000000000000000000000011111111111111111000000000000000000000000000000000000000000001111111100001111000000000000000000000000000000000000000000001111111111111111111111111000000000000000000", // 59
		"000000000000000000000000000000000000000000000000000000000000000000000000000011111111111111100000000000000000000000000000000000000000000001111110000001111000000000000000000000000000000000000000000011111111111111111111111111100000000000000000", // 60
		"000000000000000000000000000000000000000000000000000000000000000000000000000011111111111111000000000000000000000000000000000000000000000001111110000001100000000000000000000000000000000000000000000011111111111111111111111111100000000000000000", // 61
		"000000000000000000000000000000000000000000000000000000000000000000000000001111111111111110000000000000000000000000000000000000000000111111111100000000000000000000000000000000000000000000000000000011111111111111111111111111100000000000000000", // 62
		"000000000000000000000000000000000000000000000000000000000000000000000000011111111111111100000000000000000000000000000000000000000000111111111100000000000000000000000000000000000000000000000000000011111111111111111111111111000000000000000000", // 63
		"000000000000000000000000000000000000000000000000000000000000000000000000011111111111111000000000000000000000000000000000000000000000111111111100000000000000000000000000000000000000000000000000000001111111111111111111111111000000000000000000", // 64
		"000000000000000000000000000000000000000000000000000000000000000000000000011111111111110000000000000000000000000000000000000000000000111111111000000000000000000000000000000000000000000000000000000001111111111111111111111111000000000000000000", // 65
		"000000000000000000000000000000000000000000000000000000000000000000000000111111111111100000000000000000000000000000000000000000000000111111100000000000000000000000000000000000000000000000000000000000111111111111111111111111000000000000111110", // 66
		"000000000000000000000000000000000000000000000000000000000000000000000000111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001111111111111111111110000000000000111110", // 67
		"000000000000000000000000000000000000000000000000000000000000000000000000111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000111111110000000000000001110", // 68
		"000000000000000000000000000000000000000000000000000000000000000000000000111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000111000000000000000001110", // 69
		"000000000000000000000000000000000000000000000000000000000000000000000000111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000111000000000000011111100", // 70
		"000000000000000000000000000000000000000000000000000000000000000000000000111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011000000000001111111000", // 71
		"000000000000000000000000000000000000000000000000000000000000000000000011111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001111100000", // 72
		"000000000000000000000000000000000000000000000000000000000000000000000011111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001111000000", // 73
		"000000000000000000000000000000000000000000000000000000000000000000000011111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000", // 74
		"000000000000000000000000000000000000000000000000000000000000000000000000111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000", // 75
		"000000000000000000000000000000000000000000000000000000000000000000000000011110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000", // 76
		"000000000000000000000000000000000000000000000000000000000000000000000000011110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000", // 77
		"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000", // 78
		"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000", // 79
		"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000", // 80
		"000000000000000000000000000000000000000000000000000000000000000000000000000000001111111111111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000", // 81
		"000000000000000000000000000000000000000000000000000000000000000000000000000011111111111111111111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000", // 82
		"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111", // 83
		"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111", // 84
		"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111", // 85
		"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111", // 86
		"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111", // 87
		"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111", // 88
		"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111", // 89
		"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111", // 90
		"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111", // 91
		"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111", // 92
		"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111", // 93
		"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111", // 94
		"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111", // 95
	}

	rows := len(bitmap)
	cols := len(bitmap[0])

	// Braille encoding: each braille char is 2 cols x 4 rows of dots
	// Dot positions and their bit values:
	// (0,0)=0x01  (1,0)=0x08
	// (0,1)=0x02  (1,1)=0x10
	// (0,2)=0x04  (1,2)=0x20
	// (0,3)=0x40  (1,3)=0x80
	brailleBase := rune(0x2800)

	brailleRows := rows / 4
	brailleCols := cols / 2

	var sb strings.Builder
	for by := 0; by < brailleRows; by++ {
		for bx := 0; bx < brailleCols; bx++ {
			var code rune
			// Map the 2x4 block to braille dots
			for dy := 0; dy < 4; dy++ {
				for dx := 0; dx < 2; dx++ {
					py := by*4 + dy
					px := bx*2 + dx
					if py < rows && px < cols && bitmap[py][px] == '1' {
						// Braille dot encoding
						switch {
						case dx == 0 && dy == 0:
							code |= 0x01
						case dx == 0 && dy == 1:
							code |= 0x02
						case dx == 0 && dy == 2:
							code |= 0x04
						case dx == 1 && dy == 0:
							code |= 0x08
						case dx == 1 && dy == 1:
							code |= 0x10
						case dx == 1 && dy == 2:
							code |= 0x20
						case dx == 0 && dy == 3:
							code |= 0x40
						case dx == 1 && dy == 3:
							code |= 0x80
						}
					}
				}
			}
			sb.WriteRune(brailleBase + code)
		}
		sb.WriteRune('\n')
	}

	return sb.String()
}

func main() {
	// Ensure config directory exists
	if err := EnsureConfigDir(); err != nil {
		fmt.Fprintf(os.Stderr, "Warning: Could not create config directory: %v\n", err)
	}

	// Load config (non-blocking - we'll use CLI flags if provided)
	config, _ := LoadConfig()

	// Parse CLI flags (CLI takes precedence over config)
	flag.StringVar(&flagCities, "cities", "", "comma-separated list of city names (e.g., 'Tokyo,London,New York')")
	flag.StringVar(&flagPreset, "preset", "", "use predefined city groups (business, family, americas, europe, asia)")
	flag.BoolVar(&flagList, "list", false, "show all available cities and exit")
	flag.Parse()

	// Use CLI flags if provided, otherwise fall back to config
	// (config values already loaded, but CLI takes precedence)
	_ = config // Future: auto-save config if user makes changes

	// Get configured cities based on flags
	leftRegions, rightRegions, shouldRun := GetConfiguredCities()
	if !shouldRun {
		return
	}

	app := tview.NewApplication()

	// ── MAP VIEW ──
	mapView := tview.NewTextView().
		SetDynamicColors(true).
		SetTextAlign(tview.AlignCenter).
		SetScrollable(false)
	mapView.SetBorder(true).
		SetTitle(" [ World Map ] ").
		SetTitleAlign(tview.AlignCenter).
		SetBorderColor(tcell.ColorDodgerBlue)

	// ── CLOCK PANELS ──
	leftClockView := tview.NewTextView().
		SetDynamicColors(true).
		SetScrollable(false)
	leftClockView.SetBorder(true).
		SetTitle(" Americas & Europe ").
		SetTitleAlign(tview.AlignCenter).
		SetBorderColor(tcell.ColorGreen)

	rightClockView := tview.NewTextView().
		SetDynamicColors(true).
		SetScrollable(false)
	rightClockView.SetBorder(true).
		SetTitle(" Asia, Africa & Oceania ").
		SetTitleAlign(tview.AlignCenter).
		SetBorderColor(tcell.ColorOrange)

	// ── HEADER ──
	header := tview.NewTextView().
		SetDynamicColors(true).
		SetTextAlign(tview.AlignCenter).
		SetScrollable(false)

	// ── FOOTER ──
	footer := tview.NewTextView().
		SetDynamicColors(true).
		SetTextAlign(tview.AlignCenter).
		SetScrollable(false)

	// ── LAYOUT ──
	clockRow := tview.NewFlex().SetDirection(tview.FlexColumn).
		AddItem(leftClockView, 0, 1, false).
		AddItem(rightClockView, 0, 1, false)

	// Mode content view - shows mode-specific content
	modeView := tview.NewTextView().
		SetDynamicColors(true).
		SetScrollable(false)
	modeView.SetBorder(true).
		SetTitle(" [ Mode ] ").
		SetTitleAlign(tview.AlignCenter).
		SetBorderColor(tcell.ColorYellow)

	mainLayout := tview.NewFlex().SetDirection(tview.FlexRow).
		AddItem(header, 3, 0, false).
		AddItem(mapView, 28, 0, false).
		AddItem(clockRow, 0, 1, false).
		AddItem(modeView, 12, 0, false).
		AddItem(footer, 1, 0, false)

	// ── MODE SYSTEM ──
	mm := newModeManager()

	// Create and register mode handlers
	converter := newConverterMode(app)
	stopwatch := newStopwatchMode()
	timer := newTimerMode()
	alarm := newAlarmMode()

	mm.RegisterHandler(ModeConverter, converter)
	mm.RegisterHandler(ModeStopwatch, stopwatch)
	mm.RegisterHandler(ModeTimer, timer)
	mm.RegisterHandler(ModeAlarm, alarm)

	// Update mode view based on current mode
	updateModeView := func() {
		mode := mm.GetCurrentMode()
		switch mode {
		case ModeConverter:
			modeView.SetBorderColor(tcell.ColorYellow)
			modeView.SetTitle(" [ Converter ] ")
			modeView.SetText(converter.Render())
		case ModeStopwatch:
			modeView.SetBorderColor(tcell.PaletteColor(14)) // Cyan-ish
			modeView.SetTitle(" [ Stopwatch ] ")
			modeView.SetText(stopwatch.Render())
		case ModeTimer:
			modeView.SetBorderColor(tcell.ColorOrange)
			modeView.SetTitle(" [ Timer ] ")
			modeView.SetText(timer.Render())
		case ModeAlarm:
			modeView.SetBorderColor(tcell.ColorRed)
			modeView.SetTitle(" [ Alarm ] ")
			modeView.SetText(alarm.Render())
		default:
			modeView.SetBorderColor(tcell.ColorYellow)
			modeView.SetTitle(" [ Mode ] ")
			modeView.SetText("[darkgray]Press C=Converter, S=Stopwatch, T=Timer, A=Alarm[white]")
		}
		footer.SetText(mm.GetHelpText())
	}

	// ── UPDATE FUNCTION ──
	updateUI := func() {
		now := time.Now()
		utcNow := now.UTC()

		// Header with mode indicator
		modeName := ""
		if mm.GetCurrentMode() != ModeNormal {
			modeNames := map[Mode]string{
				ModeConverter: "CONVERTER",
				ModeStopwatch: "STOPWATCH",
				ModeTimer:     "TIMER",
				ModeAlarm:     "ALARM",
			}
			modeName = " | [" + modeNames[mm.GetCurrentMode()] + "]"
		}

		// Header
		headerText := fmt.Sprintf(
			"\n[::b][dodgerblue]   LOCALIZE [white]- World Time Dashboard[::-]   |   [yellow]UTC: %s[white]   |   [aqua]%s%s",
			utcNow.Format("15:04:05"),
			utcNow.Format("Monday, 02 January 2006"),
			modeName,
		)
		header.SetText(headerText)

		// Braille Map with overlaid city markers
		brailleMap := getBrailleWorldMap()
		coloredMap := colorizeBrailleMap(brailleMap)
		mapView.SetText(coloredMap)

		// Clocks
		leftClockView.SetText(formatClockPanel(leftRegions))
		rightClockView.SetText(formatClockPanel(rightRegions))

		// Mode view - only update if in a mode
		if mm.GetCurrentMode() != ModeNormal {
			updateModeView()
		}

		// Footer
		footer.SetText(mm.GetHelpText())
	}

	// ── KEY BINDINGS ──
	app.SetInputCapture(func(event *tcell.EventKey) *tcell.EventKey {
		switch event.Key() {
		case tcell.KeyEscape:
			if mm.GetCurrentMode() != ModeNormal {
				// In a mode, escape returns to normal
				mm.SwitchTo(ModeNormal)
				updateModeView()
				app.QueueUpdateDraw(func() { updateUI() })
				return nil
			}
			app.Stop()
			return nil
		case tcell.KeyRune:
			r := event.Rune()
			if r == 'q' || r == 'Q' {
				app.Stop()
				return nil
			}

			// Mode switching keys (only from Normal mode)
			if mm.GetCurrentMode() == ModeNormal {
				switch r {
				case 'c', 'C':
					mm.SwitchTo(ModeConverter)
					updateModeView()
					app.QueueUpdateDraw(func() { updateUI() })
					return nil
				case 's', 'S':
					mm.SwitchTo(ModeStopwatch)
					updateModeView()
					app.QueueUpdateDraw(func() { updateUI() })
					return nil
				case 't', 'T':
					mm.SwitchTo(ModeTimer)
					updateModeView()
					app.QueueUpdateDraw(func() { updateUI() })
					return nil
				case 'a', 'A':
					mm.SwitchTo(ModeAlarm)
					updateModeView()
					app.QueueUpdateDraw(func() { updateUI() })
					return nil
				}
			}

			// Delegate to mode handler
			if mm.GetCurrentMode() != ModeNormal {
				handled := mm.HandleKey(r)
				if handled {
					updateModeView()
					app.QueueUpdateDraw(func() { updateUI() })
					return nil
				}
			}
		}
		return event
	})

	// ── TICKER ──
	go func() {
		ticker := time.NewTicker(1 * time.Second)
		defer ticker.Stop()

		app.QueueUpdateDraw(func() { updateUI() })

		for range ticker.C {
			app.QueueUpdateDraw(func() { updateUI() })
		}
	}()

	// ── RUN ──
	if err := app.SetRoot(mainLayout, true).EnableMouse(false).Run(); err != nil {
		panic(err)
	}
}

// colorizeBrailleMap takes the raw braille map string and adds color tags +
// overlays city markers at their positions.
func colorizeBrailleMap(brailleMap string) string {
	lines := strings.Split(strings.TrimRight(brailleMap, "\n"), "\n")

	// Overlay city markers onto map lines
	// We replace braille chars at specific positions with colored city labels
	for _, m := range cityMarkers {
		if m.row < len(lines) {
			runes := []rune(lines[m.row])
			label := m.label
			// Ensure the label fits
			if m.col+len(label) <= len(runes) {
				// Build the replacement: color tag + label + reset + rest
				before := string(runes[:m.col])
				after := string(runes[m.col+len(label):])
				lines[m.row] = before + fmt.Sprintf("[%s::b]%s[-::-]", m.color, label) + after
			}
		}
	}

	var sb strings.Builder
	for _, line := range lines {
		// Wrap each line in green color for the braille land dots
		// but preserve any already-injected color tags for markers
		sb.WriteString("[green]")
		sb.WriteString(line)
		sb.WriteString("[-]\n")
	}

	return sb.String()
}

// formatClockPanel builds a formatted clock display for a set of regions.
func formatClockPanel(regs []Region) string {
	var b strings.Builder
	b.WriteString("\n")

	for _, r := range regs {
		loc, err := time.LoadLocation(r.Timezone)
		if err != nil {
			b.WriteString(fmt.Sprintf("  [red]%-13s  ERROR[-]\n", r.Name))
			continue
		}

		now := time.Now().In(loc)
		timeStr := now.Format("15:04:05")
		dateStr := now.Format("Mon, 02 Jan 2006")
		offsetStr := now.Format("-07:00")
		dayPhase := getDayPhase(now)
		colorTag := colorToTag(r.Color)

		b.WriteString(fmt.Sprintf(
			"  [%s::b]%-13s[-::-] [white::b]%s[-::-]  [silver]%s  [darkgray]UTC%s  %s\n",
			colorTag,
			r.Name,
			timeStr,
			dateStr,
			offsetStr,
			dayPhase,
		))
	}

	return b.String()
}

// getDayPhase returns a colored label for the time of day.
func getDayPhase(t time.Time) string {
	hour := t.Hour()
	switch {
	case hour >= 5 && hour < 8:
		return "[#FFA07A]Dawn[-]"
	case hour >= 8 && hour < 12:
		return "[yellow]Morning[-]"
	case hour >= 12 && hour < 17:
		return "[#FFD700]Afternoon[-]"
	case hour >= 17 && hour < 20:
		return "[orange]Evening[-]"
	case hour >= 20 && hour < 22:
		return "[#CD853F]Dusk[-]"
	default:
		return "[#6A5ACD]Night[-]"
	}
}

// colorToTag maps tcell.Color to tview color tag strings.
func colorToTag(c tcell.Color) string {
	colorMap := map[tcell.Color]string{
		tcell.ColorDodgerBlue:  "dodgerblue",
		tcell.ColorDarkCyan:    "darkcyan",
		tcell.ColorGreen:       "green",
		tcell.ColorDarkGreen:   "darkgreen",
		tcell.ColorRed:         "red",
		tcell.ColorGold:        "gold",
		tcell.ColorOrange:      "orange",
		tcell.ColorDarkMagenta: "darkmagenta",
		tcell.ColorDeepPink:    "deeppink",
		tcell.ColorYellow:      "yellow",
		tcell.ColorLimeGreen:   "limegreen",
		tcell.ColorSandyBrown:  "sandybrown",
		tcell.ColorCoral:       "coral",
		tcell.ColorLightCyan:   "lightcyan",
		tcell.ColorTurquoise:   "turquoise",
		tcell.ColorOrangeRed:   "orangered",
	}
	if tag, ok := colorMap[c]; ok {
		return tag
	}
	return "white"
}
